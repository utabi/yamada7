# yamada7 デザイン仕様

## 目標

LLM を意思決定の中核に据えた自律システムを構築し、「生存を最優先」に行動する過程で恐怖心と好奇心の創発メカニズムを観測する。システムは環境と継続的にインタラクションし、危険回避と未知探索を自律的にバランスさせる。

## 全体構成

```
┌────────┐   状態要約    ┌──────────┐   行動指示   ┌────────┐
│  環境API │ ─────────→ │  状態整形器 │ ─────────→ │  LLM思考 │
└────────┘             └──────────┘             └────────┘
      ↑                   反省ログ ↑        ↓ 思考ログ
      │                              │
      │        結果要約   ┌──────────┐   行動実行   ┌────────┐
      └───────────────────│  結果整形器 │────────────→│ 実行エンジン │
                          └──────────┘               └────────┘
                                                         ↓
                                                 ┌────────────┐
                                                 │ ダッシュボード │
                                                 └────────────┘
```

- **LLM思考**: 観測・記憶・評価基準を受け取り、計画・行動列・リスク評価・反省を言語化する。  
- **状態整形器 / 結果整形器**: 観測値や実行結果を定型テキストに変換し、LLMコンテキストを最適化。  
- **実行エンジン**: LLM出力を安全に解釈し、環境APIに対して順次行動コマンドを送る。  
- **環境API**: シミュレータ／Mac操作層など。状態取得とコマンド入力のインターフェースを提供する。

## フィードバックループ

各ターンで以下を自動化する。

1. **状態収集**  
   - 観測: 位置、資源、残ライフ、危険推定、未知度、直近の被ダメージなどを取得。  
   - 記憶アクセス: 過去の恐怖辞典（危険事例）、探索ログ、メタ学習ノートの該当部分を抽出。
2. **状態整形**  
   - JSON 形式の生データをテンプレートに沿った短文へ変換。  
   - スロット例: `基本状態`, `危険指標`, `未知度`, `資源`, `トップリスク`, `トップチャンス`。
3. **LLM計画**  
   - 入力: 前ターン反省、現在状態、候補アクション集合、報酬スキーマ。  
   - 出力: 目的、サブゴール、行動列（ツール使用含む）、リスク評価、想定報酬、警戒点。
4. **行動実行**  
   - 実行エンジンが行動列を逐次実施。  
   - 失敗／危険兆候は即座にフラグ化し、ターン内で中断・軌道修正できるようにする。
5. **結果整形と反省**  
   - 実績報酬、被ダメージ、得た情報量、状態変化をまとめる。  
   - LLMが反省文、警戒ログ更新事項、探索優先度調整を生成。  
   - 反省ログを次ターンのコンテキストとして蓄積。

## ACE（Agentic Context Engineering）の導入

従来のメモリ要約は短文化により重要知見を喪失するリスクがあった。yamada7ではACEアプローチを採用し、コンテキストを「上書き」ではなく「差分更新」する。

- **Executor**: 既存プレイブックと短期ログを参照してタスクを遂行（既存 `FeedbackLoop` が該当）。  
- **Reflector**: 実行履歴を解析し、どの知識を追加・修正すべきか差分候補（デルタ）を生成。  
- **Curator**: Reflectorから受け取ったデルタを検証し、プレイブックへ安全にマージ。矛盾や劣化を防ぐ。  
- **Playbook Store**: カテゴリ別に編纂されたプレイブックを保持し、バージョン管理とGrow-and-Refine処理を担当。

ACEでは以下の2段階更新を行う：

1. **Incremental Delta Update** – 各ターンごとに差分を記録し、即時活用可能なプレイブック差分を生成。  
2. **Grow-and-Refine** – 一定ターンごとに差分を再構成し、重複や古い知識を整理して品質を保つ。

差分はJSON形式で `data/playbook/deltas/` に保存し、適用後の最新版はMarkdownとJSONメタデータとして `data/playbook/current/` に配置する。ダッシュボードでは差分履歴をタイムラインとして閲覧できる。

`refine_interval` が設定されている場合、Grow-and-Refine処理は各ファイルにつき最新 `playbook_max_sections` 件のみを残し、古いセクションを `archive/` に退避させる。これによりトークン肥大化と知識劣化を防止する。プレイブック抜粋は最大 `playbook_context_limit` 件、1件あたり `playbook_context_chars` 文字をLLMに供給する。

ダッシュボードには最新差分に加えて統計情報（ファイル数・セクション数・総文字数）が表示され、プレイブックの肥大化をリアルタイムに把握できる。

バックエンドは `/sse/timeline` のServer-Sent Eventsで最新スナップショットをストリームし、フロントエンドはEventSourceで受信してメトリクス／イベント／プレイブック情報を即時更新する。

CLIから `--episodes` オプションを指定すると複数エピソードを連続実行し、平均ティック数や平均報酬を集計する。`--save-run` を指定すると各スナップショットを JSONL として保存でき、後からACEの進化過程を解析できる。

`scripts/analyze_snapshots.py` で保存済みJSONLを読み込み、エピソード指標やプレイブック更新の頻度分布を確認できる。上位ターゲットの把握によりCuratorの閾値調整やGrow-and-Refine方針見直しに活用する。

`--save-report` を指定すると、エピソードごとの統計をまとめたJSONを出力し、外部ダッシュボードや分析パイプラインに取り込める。

CLIの `--linger` で実行終了後もプロセスを一定時間維持し、ブラウザからSSEダッシュボードを確認する余裕を確保できる。

`--tick-delay` により1ターンあたりの待機時間を設定でき、デフォルトでは約20秒のフィードバックループとなる。運用環境に合わせて調整する。

`tests/` フォルダに PlaybookStore とログ解析のユニットテストを配置し、`pip install .[dev]` 後に `PYTHONPATH=./src pytest` で検証できる。

## 報酬と内発動機

- **外部報酬**  
  - 生存時間（ターン継続ボーナス）  
  - ライフ残量・資源保持・安全圏滞在などの正報酬  
  - ダメージ・危険区域滞在・致死イベントの負報酬
- **内部報酬**  
  - 未知領域探索による情報獲得量（例: RND/ICM の予測誤差）  
  - 危険予測が的中した際の「防衛成功」ボーナス  
- **LLMへの提示方法**  
  - 数値スロットを表形式または箇条書きで提示し、LLM自身がテキスト内で重み付けを言語化する。  
  - 「生存 > 回収 > 探索」という優先順位を明示しつつ、例外条件（危険度閾値など）を自律的に調整させる。

## 記憶構造

| メモリ | 用途 | 更新タイミング |
|--------|------|----------------|
| 警戒ログ | 危険要因、発生条件、回避策 | LLM反省フェーズ |
| 探査ログ | 未探索エリア、取得済み資源、発見物 | 行動実行後 |
| メタノート | 方針変更やプロンプト改善案 | エピソード終了時 |
| プレイブック | ACEが管理する長期知識（戦術・レシピ・反省） | 差分適用時 |

短期メモリ（警戒ログ・探査ログ・メタノート）は外部ストレージ (JSON/SQLite) とし、ターンごとに関連部分のみチャンク化してLLMに渡す。プレイブックはACEモジュールが差分適用を管理し、LLMには必要箇所のみ抜粋を提示する。

## 安全と制御

- 行動実行層でホワイトリスト化されたコマンドのみ許可し、LLM出力を直接実行しない。  
- 危険度が閾値を超えた場合は自動停止、または緊急回避アクションをトリガーする。  
- Mac 操作モードでは GUI 操作・ファイルアクセスの権限を段階的に与え、ログを常時記録する。

## 可視化ダッシュボード

- **目的**: フィードバックループの全体像をブラウザでリアルタイムに監視し、恐怖・好奇心の推移や意思決定の根拠を確認する。  
- **表示内容**  
  - 生存スコア、残ライフ、危険指標、未知度などの主要メトリクス。  
  - 行動タイムラインと各ステップの報酬／損失／危険シグナル。  
  - LLMの計画・反省・警戒ログ更新の抜粋、およびメモリ状態。  
  - プレイブック差分（Reflector提案、Curator適用結果）のタイムライン。  
  - アラート（致死リスク接近、ルール違反、緊急停止、閾値超過）。  
- **構成**  
  - バックエンドが整形済みデータをWebソケット or SSE/ポーリングで提供。  
  - フロントエンドは軽量SPA（例: React + Vite）を想定し、チャートとログビューを組み合わせて可視化。  
  - 調整パネルで危険度閾値、探索ボーナス係数、ログ詳細度、通知設定を変更できるようにする。  
  - 初期実装では FastAPI + Chart.js によるポーリングUI（ `/ui` 配下の静的ファイル）を提供。  
  - `/metrics`, `/events`, `/snapshots` といったJSON API経由で外部分析ツールとの連携を可能にする。

## LLM Playground

- **目的**: `playground/` ディレクトリをLLMが自由に操作できる実験場とし、プロンプト改変・コード断片生成・検証スクリプト作成を制約なく行えるようにする。  
- **利用方針**  
  - 生成物はそのままコミット候補として扱わず、必要に応じて上位ディレクトリへ昇格または編集する。  
  - フィードバックループ本体とは疎結合とし、Playgroundで得た成果を状態整形器やMemory Manager経由で取り込む。  
  - 不要ファイルの自動削除は行わず、エピソード単位で整備する。
- **同期と安全**  
  - Playground内の実験ログはDashボードに任意で公開できるオプションを設ける。  
  - 実行エンジンはPlayground内のスクリプトに限定権限でアクセスし、外部への影響を抑制する。  
  - 危険度の高いコマンドはSafety Sentinelの審査対象とし、サンドボックス外への副作用を防ぐ。

## エージェント構成

### 1. Core Thinker (LLM)

- **役割**: 状態評価、計画立案、リスク解析、反省ログ生成。  
- **入力**: 状態要約、候補アクション、報酬スキーマ、記憶抜粋（恐怖辞典・探索ログ）。  
- **出力**: 目的とサブゴール、行動列、期待報酬・危険度、反省と改訂方針。  
- **備考**: 出力は構造化テキスト（例: YAML 風）を想定。トークン節約のためテンプレート化する。
  - Claude Code CLI を利用する場合は `claude code --dangerously-skip-permissions` をデフォルトで付与し、JSON形式で行動計画と反省を返す。

### 2. State Formatter

- **役割**: 環境APIから得た生データをLLM向けのコンパクトな記述に変換。  
- **入力**: 観測 JSON、記憶モジュールからの参照リクエスト。  
- **出力**: テンプレート化された状態要約（例: 現在地、残ライフ、危険指標、未知度、重要イベント）。  
- **備考**: トークン数が閾値を超える場合は優先度付きサマリを生成。

### 3. Result Formatter

- **役割**: 行動後の結果・報酬・副作用を整理し、反省フェーズ用のレポートを作成。  
- **入力**: 実行エンジンのログ、環境APIからのフィードバック。  
- **出力**: 実績報酬、被ダメージ、得た情報量、未解決リスク、失敗イベント。

### 4. Execution Engine

- **役割**: LLMが提示した行動列を検証し、ホワイトリスト化されたコマンドにマッピングして実行。  
- **入力**: 行動列（操作タイプ、対象、パラメータ）。  
- **出力**: 実行ステータス、エラー、即時リスクフラグ。  
- **備考**: 危険閾値超過時には自動的に緊急停止や回避アクションをトリガーする。

### 5. Memory Manager

- **役割**: 警戒ログ・探査ログ・メタノートなどの短期記憶の管理。  
- **入力**: 反省ログ、実行結果、環境メタデータ。  
- **出力**: LLM向け抜粋、要約、頻出パターン分析。  
- **備考**: 外部ストレージに保存し、ターンごとに関連度の高いチャンクのみ渡す。

### 6. Reward Synthesizer

- **役割**: 外部報酬と内部報酬を統合し、LLMに提示できるスコアボードを生成。  
- **入力**: 生存指標（ライフ、ターン数）、資源値、探索メトリクス、危険予測精度。  
- **出力**: スコア表、トレードオフ警告、報酬トレンド（移動平均など）。  
- **備考**: 好奇心ボーナスと生存コストのバランスを動的調整する係数を保持する。

### 7. Dashboard Presenter

- **役割**: 複数エージェントからのデータを集約し、ブラウザUIダッシュボードにリアルタイムで表示。  
- **入力**: 状態整形器／結果整形器／Reward Synthesizer／思考ログからの整形済みデータストリーム。  
- **出力**: Webソケット/SSE経由の配信、UIコンポーネント向けJSON、通知イベント。  
- **備考**: 閾値設定やフィルタリングの変更を双方向で受け付け、他エージェントへフィードバックする。

### 8. ACE Reflector

- **役割**: Executorの行動結果とメトリクスを分析し、プレイブックへの差分候補（デルタ）を生成。  
- **入力**: `LoopSnapshot`, メトリクス履歴、既存プレイブックの該当チャンク。  
- **出力**: `delta` ブロック（対象セクション、変更内容、根拠、優先度）。  
- **備考**: LLM（Claude CLI など）を用いて生成し、禁止ワードなしのフォーマットを強制する。

### 9. ACE Curator

- **役割**: Reflectorが生成したデルタを検証し、矛盾や重複がないか確認してプレイブックに適用。  
- **入力**: デルタ候補、既存プレイブック、統計情報。  
- **出力**: 適用結果（適用/保留/却下）、更新後のプレイブック断片。  
- **備考**: Grow-and-Refine処理を担当し、バージョン管理やロールバック機構も保持する。

### 10. Playbook Store

- **役割**: プレイブック本文、差分履歴、メタデータをファイルシステム上で管理。  
- **入力**: Curatorが承認したデルタ、ロールバック指示。  
- **出力**: 現行プレイブックのチャンク、差分ヒストリー、統計情報（トークン長、カテゴリ別カバレッジ）。  
- **備考**: JSON/Markdown/JSONLの複合形式で保存し、ダッシュボードやLLMに供給する。

### 11. Safety Sentinel (任意導入)

- **役割**: LLM出力や実行結果を監視し、危険行動や倫理的に不適切な操作をブロック。  
- **入力**: LLMプラン、実行ログ、環境からの危険アラート。  
- **出力**: ブロック指示、警告メッセージ、必要に応じたフォールバックプラン。  
- **備考**: 将来的には別LLMまたはルールベースエージェントとして実装。

### 12. Playground Custodian (任意導入)

- **役割**: `playground/` 内で生成されたスクリプト・メモ・試験ログを整理し、本体システムへ取り込むかどうかを判断する。  
- **入力**: Playground内ファイルイベント、LLMからのメタノート、ダッシュボード経由の公開設定。  
- **出力**: 重要成果の昇格リクエスト、不要ファイルの整理提案、ダッシュボード共有メタデータ。  
- **備考**: 自動化しない場合は人間監督が担当し、Safety Sentinelと連携して危険操作を検査する。

## 開発フェーズ

1. **シミュレータ段階**  
   - 軽量なGridworldでループを構築し、恐怖辞典と探索ボーナスのバランスを検証。  
   - CLIベースでターン進行を可視化、ログを集計。
2. **ハイブリッド段階**  
   - 一部の行動をMac操作に置き換え、実行エンジンの安全性と遅延を評価。  
   - 記憶モジュールと状態整形器を拡張。
3. **完全統合段階**  
   - 実環境での自律運用を試験。  
   - 長時間稼働での安定性、恐怖・好奇心の挙動、自己改善ループを観測。

## 評価指標

- 平均生存ターン数／最高スコア  
- 危険回避成功率と致死イベントの内訳  
- 未知領域の探索率と情報獲得量  
- LLM思考ログの質的分析（恐怖辞典の精度、方針改善の頻度）

## 今後の課題

- トークン効率を高めるための状態要約手法の設計  
- LLMが危険を過小評価した際の自動訂正メカニズム  
- 長期記憶の肥大化抑制と重要情報抽出の自動化  
- 多エージェント化（協力・競合）による恐怖／好奇心の相互作用の検証

## 実装進捗スケッチ

- `src/yamada7/core/loop.py`: フィードバックループのオーケストレーション。  
- `src/yamada7/env/gridworld.py`: 軽量サバイバル志向のグリッド環境。  
- `src/yamada7/llm/thinker.py`: LLMモードを切り替え、Claude CLI 応答をActionPlan/Reflectionにマッピング。  
- `src/yamada7/llm/claude_cli.py`: `claude code` CLI をブリッジし、`--dangerously-skip-permissions` 付きで実行するオプション。  
- `src/yamada7/ace/`: Reflector・Curator・Playbook Store のACE実装（導入中）。  
- `src/yamada7/dashboard/server.py`: FastAPIベースのダッシュボードバックエンド。  
- `src/yamada7/dashboard/static/`: Chart.js を用いた軽量UI（ `/ui/index.html` から利用）とイベント／プレイブック表示。  
- `scripts/run_sim.py`: シミュレーション実行用CLI。  
- `data/playbook/`: ACEが生成するプレイブックの保存領域。  
- `playground/`: LLMが自由に試行するサンドボックス。  
今後は実際のLLM呼び出しやフロントエンドUIを差し替えていく。
